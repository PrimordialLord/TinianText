# 电商数仓-商品主题营销工具客服专属优惠看板设计文档
## 一、项目基本信息
|项目名称|电商数仓|
| ---- | ---- |
|工单编号|大数据-电商数仓-08-商品主题营销工具客服专属优惠看板|
|创建时间|2025.1.25|
|创建人|郭洵|
|目标用户|电商商家|
|核心需求|查看客服专属优惠的活动效果，以提高客服询单转化率，整体提升店铺销量|

## 二、业务概述
### （一）客服专属优惠定义
客服专属优惠是用于客服跟消费者聊天场景的专属工具，可直接在商品金额上立减，支持和其他优惠叠加，并且不计入最低价，能有效帮助商家提高客服询单转化率，进而提升店铺销量。

### （二）适用范围
适用于淘宝&天猫商家。

### （三）核心价值
1. 不计入最低价，支持改价，助力私域运营成交。
2. 提高新客客服询单转化率，提升店铺销量。
3. 结合私域产品，帮助店铺吸纳更多粉丝。
4. 安抚价格敏感用户，促进二次转化。
5. 针对老客提供专属优惠，提升用户留存，促进二次复购。

## 三、功能模块设计
### （一）优惠创建模块
1. **创建入口**：登录【千牛工作台】-【接待管理】-【接待工具】，找到客服专属优惠。
2. **操作步骤**
    - 第一步：找到专属优惠入口，点击优惠管理-右上角【立即创建】。
    - 第二步：填写通用信息
        - 活动级别：支持商品级和SKU级。商品级指同一个商品下所有SKU是一个价格；SKU级指同一个商品下不同的SKU可以是不同的价格，且发送后买家只能购买对应的SKU，其他SKU不享受优惠金额。
        - 活动名称：不超过10个字，便于查询，例如“818开业五周年回馈”。
        - 活动时间：支持2-120天设置。
        - 消费者可使用效期：无需设置，由客服发送时自定义填写（24小时以内）。
        - 优惠类型：分为固定优惠和自定义优惠。固定优惠指同一个商品的优惠是固定的金额；自定义优惠指后台设置优惠金额上限后，客服在接待时可自由填写限制以下的优惠额度。
    - 第三步：选择商品并设置优惠
        - 选择商品：可手动添加或批量导入，上限500个，预售定金期、百亿补贴商品暂时不支持。手动选择时，点击后可手动添加商品，左下角支持全选当前页商品，每次可添加100个，上限500个；批量导入时，首次需下载导入模板，按照模板要求填写商品id等，上限500个。
        - 填写商品优惠金额：金额必须是整数，且不高于商品金额，不超过5000元。
        - 查看预估到手价：平台会根据填写的优惠金额，展示预估到手价及凑单预估到手价的区间。正常到手价是消费者没有凑单情况的到手价；最低到手价是消费者凑单的到手价，不满足门槛的优惠也会按凑单金额比例折算。
        - 填写每人限购次数：默认1次，可更改次数（无上限）。例如填写5次，则一个消费者可以购买5件且均享受对应优惠，如果消费者本次只使用了3次，过期后可再次发送此专属优惠给对应消费者，其可再使用2次。
        - 移出：对于不想纳入专属优惠的商品可以进行移出处理，移出后可再行添加。
        - 批量操作：可进行批量移出、批量设置优惠、批量设置限购次数操作。
    - 第四步：设置SKU级优惠。针对SKU级优惠，选择优惠商品后，需要为每个商品单独设置SKU优惠，每个商品下至少需设置一个SKU优惠，最多设置50个。
3. **设置规则**
    - 一个店铺有效活动上限：50个（不包括已结束）。
    - 一个商品有效活动上限：不超过5个（商品+SKU级）。
    - 一个活动活动商品上限：500个商品。
    - 所有活动下报名商品数：5000个商品。

### （二）优惠修改模块
1. **修改活动**：仅针对正在生效、未开始的活动（已结束不可修改）。
    - 若活动生效中：设置结束时间需保证在今天后的120天内。
    - 若活动未开始：可以设置任意结束时间。
2. **修改商品**：仅针对正在生效、未开始的活动（已结束不可修改），只能新添加商品或移除未发布的商品，已发布的商品无法进行修改，只能操作暂停活动。
    - 添加商品：选择商品后，同创建优惠流程，设置新加商品的优惠金额和限购次数。
    - 移出商品：如果24小时内该商品下的该活动没有发送优惠记录，可以从活动中操作移出商品。
3. **暂停/开启活动**：对已经进行的商品活动进行暂停和开启，暂停后客服侧不可发送。
4. **删除活动**：新增活动删除功能，若符合以下条件的均可以进行删除处理。
    - 生效中：如果所有商品均移出可以删除。
    - 已暂停：暂停时间大于24小时的可以删除。
    - 已结束：可以直接操作删除。
5. **查看数据**：支持查看该活动的数据情况。

### （三）优惠使用模块
1. **使用入口**
    - PC端：进入【千牛接待工作台】-聊天工具框-找到【专属优惠】的图标。
    - 无线端：进入【接待对话页面】-聊天工具框-找到【专属优惠】的图标。
2. **发送优惠步骤**
    - 选择优惠商品：可直接选择“当前有优惠”商品，预售定金期和百亿补贴商品无法选择。
    - 选择优惠级别：发送优惠级别，若优惠未设置的会引导去设置。商品级适用于整个商品；SKU级仅支持到SKU，需选择需要发放的SKU。
    - 选择优惠金额：可看到该商品已设置的优惠，如果该优惠24小时内已发送消费者，则不可再发送，需等消费者核销后或24小时结束后，再次发送。
    - 填写优惠金额：若优惠类型是自定义金额，需要在发送时输入具体优惠金额（上限金额范围内）。
    - 填写消费者使用有效期：指发送给消费者后，其可以使用的有效期，默认24小时，可设置1-24小时之内。
    - 查看消费者可使用次数：消费者可使用次数是在后台设置在商品上的限购次数，需提前设置。
    - 备注：选填，仅内部协同用，可填写发送优惠原因，买家不可见。
    - 预估到手价区间：预估到手价指所选时间段内，当前商品可享受到的优惠，并且叠加本次客服专属优惠计算得出；凑单预估到手价指消费者凑单的极限到手价，不满足门槛的优惠也会按凑单金额比例折算。
    - 优惠明细：在每个优惠后面有小问号，移动显示活动id，可查询具体活动。
    - 低价预警：红线价是在营销中心自行设置的价格，若未设置，默认为商品标价的四折。
    - 优惠发送卡控：若客服优惠的金额本身大于商品SKU最低金额，则不允许发送。
3. **买家使用流程**
    - 买家查看：消费者在手淘的聊天窗口、商品详情、购物车、下单页都能看到专属优惠，内容包括商品、立减的金额、下单的有效时间。
    - 使用时效：根据设置的优惠时间，买家侧会展示倒计时，超过此时间会显示优惠已过期，无法享受优惠。
    - 买家下单：买家通过聊天卡片、购物车、商品详情均可享受专属优惠，可叠加各种类型优惠。

### （四）数据看板模块
1. **工具效果总览**：展示选定周期内通过客服专属优惠支付买家的支付总览，活动效果展示不同状态下单个活动效果数据。
    - 时间维度：日、7天、30天。
    - 活动状态：进行中、已结束。
2. **数据概览**：可查看30天、7天、昨天的发送及核销概览数据，包括发送金额、累计发送次数、累计支付金额、累计支付次数、支付买家数等。
3. **客服数据**：查看每个客服发送及核销的情况。
4. **发送明细**：查看每一条发送的明细及核销情况，包括发送次数、支付次数等。
    - 发送次数：指统计周期内的发送总和。
    - 支付次数：指统计周期内的支付总和。
    - 支付次数可能大于发送次数，原因是优惠的使用周期有24小时，例如统计6月18日的发送次数和支付次数，会统计进6月17日发送的优惠在618支付的订单。

## 四、数据模型设计
### （一）ODS层表设计
1. **ods_customer_service_preferential_raw**
    - 用途：存储客服专属优惠的原始数据，包括活动创建、修改、发送、核销等相关日志数据。
    - 字段：log_id（日志ID）、operation_type（操作类型，如创建、修改、发送、核销等）、data（原始数据JSON）、create_time（日志创建时间）、dt（数据日期）。

### （二）DWD层表设计
1. **dwd_customer_service_preferential_activity**
    - 用途：存储客服专属优惠活动的基础明细数据。
    - 字段：activity_id（活动ID）、activity_name（活动名称）、activity_level（活动级别，商品级/ SKU级）、preferential_type（优惠类型，固定优惠/自定义优惠）、start_time（活动开始时间）、end_time（活动结束时间）、max_preferential_amount（最大优惠金额）、create_time（活动创建时间）、update_time（活动更新时间）、etl_time（ETL处理时间）、dt（数据日期）。
2. **dwd_customer_service_preferential_product**
    - 用途：存储参与优惠活动的商品明细数据。
    - 字段：id（记录ID）、activity_id（活动ID）、product_id（商品ID）、sku_id（SKU ID，商品级为null）、preferential_amount（优惠金额）、limit_purchase_count（每人限购次数）、add_time（添加时间）、remove_time（移除时间，未移除为null）、etl_time（ETL处理时间）、dt（数据日期）。
3. **dwd_customer_service_preferential_send**
    - 用途：存储优惠发送明细数据。
    - 字段：send_id（发送ID）、activity_id（活动ID）、product_id（商品ID）、sku_id（SKU ID）、customer_service_id（客服ID）、customer_id（消费者ID）、send_preferential_amount（发送优惠金额）、valid_period（有效时长，单位小时）、send_time（发送时间）、remark（备注）、etl_time（ETL处理时间）、dt（数据日期）。
4. **dwd_customer_service_preferential_use**
    - 用途：存储优惠核销（使用）明细数据。
    - 字段：use_id（核销ID）、send_id（发送ID）、order_id（订单ID）、use_time（核销时间）、actual_preferential_amount（实际优惠金额）、etl_time（ETL处理时间）、dt（数据日期）。

### （三）DWS层表设计
1. **dws_customer_service_preferential_activity_summary**
    - 用途：按活动汇总优惠活动数据。
    - 字段：activity_id（活动ID）、activity_name（活动名称）、send_count（发送次数）、send_total_amount（发送总金额）、use_count（核销次数）、use_total_amount（核销总金额）、pay_buyer_count（支付买家数）、start_time（活动开始时间）、end_time（活动结束时间）、etl_time（ETL处理时间）、dt（数据日期）。
2. **dws_customer_service_preferential_customer_service_summary**
    - 用途：按客服汇总优惠发送及核销数据。
    - 字段：customer_service_id（客服ID）、send_count（发送次数）、send_total_amount（发送总金额）、use_count（核销次数）、use_total_amount（核销总金额）、etl_time（ETL处理时间）、dt（数据日期）。

### （四）ADS层表设计
1. **ads_customer_service_preferential_overview**
    - 用途：客服专属优惠工具效果总览数据。
    - 字段：stat_period（统计周期，日/7天/30天）、send_count（累计发送次数）、send_total_amount（发送总金额）、use_count（累计支付次数）、use_total_amount（累计支付金额）、pay_buyer_count（支付买家数）、stat_date（统计日期）、dt（数据日期）。
2. **ads_customer_service_preferential_activity_effect**
    - 用途：不同状态下单个活动效果数据。
    - 字段：activity_id（活动ID）、activity_name（活动名称）、activity_status（活动状态，进行中/已结束）、send_count（发送次数）、send_total_amount（发送总金额）、use_count（核销次数）、use_total_amount（核销总金额）、pay_buyer_count（支付买家数）、stat_date（统计日期）、dt（数据日期）。
3. **ads_customer_service_preferential_customer_service_data**
    - 用途：每个客服发送及核销情况数据。
    - 字段：customer_service_id（客服ID）、customer_service_name（客服名称）、send_count（发送次数）、send_total_amount（发送总金额）、use_count（核销次数）、use_total_amount（核销总金额）、conversion_rate（转化率，核销次数/发送次数）、stat_date（统计日期）、dt（数据日期）。
4. **ads_customer_service_preferential_send_detail**
    - 用途：每一条发送的明细及核销情况数据。
    - 字段：send_id（发送ID）、activity_id（活动ID）、activity_name（活动名称）、product_id（商品ID）、product_name（商品名称）、customer_service_id（客服ID）、customer_service_name（客服名称）、send_time（发送时间）、send_preferential_amount（发送优惠金额）、valid_period（有效时长）、use_status（使用状态，已使用/未使用）、use_time（核销时间）、order_id（订单ID）、remark（备注）、stat_date（统计日期）、dt（数据日期）。

## 五、关键指标实现方案
1. **发送次数**：统计周期内`dwd_customer_service_preferential_send`表中`send_id`的总条数。
2. **发送总金额**：统计周期内`dwd_customer_service_preferential_send`表中`send_preferential_amount`的总和。
3. **核销次数（支付次数）**：统计周期内`dwd_customer_service_preferential_use`表中`use_id`的总条数。
4. **核销总金额（支付总金额）**：统计周期内`dwd_customer_service_preferential_use`表中`actual_preferential_amount`的总和。
5. **支付买家数**：统计周期内`dwd_customer_service_preferential_use`表中去重后的`customer_id`的数量。
6. **转化率**：统计周期内核销次数与发送次数的比值，即（核销次数/发送次数）*100%。

## 六、数据生成与代码实现要求
1. 本任务必须使用spark 3.2及以上的版本，使用PySpark+Sparksql实现。
2. 代码注释需包括工单编号：大数据-电商数仓-08-商品主题营销工具客服专属优惠看板。
3. 营销工具客服专属优惠看板代码需实现全部指标的功能，包括不分层、分层两种实现方式，代码需有明确的注释。

## 七、验收标准
1. 包括各业务表结构，数据生成代码。
2. 营销工具客服专属优惠看板设计文档需包括ADS层表设计、原始数据分析、关键指标实现方案，需写出明确的实现思路。
3. 营销工具客服专属优惠看板代码需实现全部指标的功能，包括不分层、分层两种实现方式，代码需有明确的注释。
4. 营销工具客服专属优惠看板测试文档需含测试记录及测试sql，同时分层、不分层两种实现方式的数据需一致。
5. 营销工具客服专属优惠看板上线截图需包括截图的时间，需能清晰看到指标数值。

## 九、产出物
1. 营销工具客服专属优惠业务库表设计，数据生成代码。
2. 营销工具客服专属优惠看板设计文档。
3. 营销工具客服专属优惠看板代码。
4. 营销工具客服专属优惠看板测试文档。
5. 营销工具客服专属优惠看板上线截图。